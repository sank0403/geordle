<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>CHN LNK Migration</title>
</head>
<body>
<script>
console.log("[POPUP] migrate.html loaded");
console.log("[POPUP] Initial origin:", location.origin);
console.log("[POPUP] opener exists:", window.opener !== null);

const fixedKeys = [
  'clMysteryLetter','clwordtwo','monthcl_lastMonth','clcorrect',
  'cldisabledkey','cldynamiteUsedThisRound','consocount','clguesscnt',
  'clwordone','clstarscnt','clBuildVersion','clwordfour','monthwins',
  'clwordfive','starcl1count','starcl5count','monthclstars','vowelcount',
  'clshowrules','totalclwins','clgamecnt','playerName','clshowalert',
  'clhardmode','clwordlast','gameclwon','starclxcount','vowelactive',
  'clwordsix','cllivescnt','totalclplayed','cllives','starcl4count',
  'monthclplayed','totalclstars','starcl3count','clMysteryActive',
  'clgamestarted','cldynamite','starcl0count','totalclstreak',
  'starcl2count','clwordthree','skipReloadOnce',
  'cldynamiteTutorialShown','cltradeoffered'
];

const prefixes = [
  'gameovercl',
  'gamestatcl',
  'archstatcl',
  'archovercl'
];

// Wait until popup has a real origin (GitHub Pages timing fix)
function sendWhenReady() {
  console.log("[POPUP] Checking origin:", location.origin);

  if (location.origin === "null" || location.origin === "about:blank") {
    console.warn("[POPUP] Origin not ready. Retrying...");
    return setTimeout(sendWhenReady, 30);
  }

  console.log("[POPUP] Origin ready:", location.origin);

  const data = {};

  // Copy fixed keys
  fixedKeys.forEach(key => {
    const value = localStorage.getItem(key);
    if (value !== null) data[key] = value;
  });

  // Copy dynamic prefix keys
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (prefixes.some(prefix => key.startsWith(prefix))) {
      data[key] = localStorage.getItem(key);
    }
  }

  console.log("[POPUP] Sending data to opener:", data);
  console.log("[POPUP] opener exists:", window.opener !== null);

  // Send to opener (main site validates origin)
  window.opener.postMessage(
    { type: "LOCALSTORAGE_MIGRATION", payload: JSON.stringify(data) },
    "https://thechnlnk.com"
  );

  console.log("[POPUP] Message sent. Closing popup...");
  window.close();
}

sendWhenReady();
</script>
</body>
</html>
